(window.webpackJsonp=window.webpackJsonp||[]).push([[26],{300:function(s,a){s.exports="data:image/png;base64,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"},329:function(s,a,t){"use strict";t.r(a);var n=t(10),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"java-并发-理论基础"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#java-并发-理论基础"}},[s._v("#")]),s._v(" Java 并发 - 理论基础")]),s._v(" "),a("p",[s._v("本文从理论的角度引入并发安全问题以及JMM应对并发问题的原理。")]),s._v(" "),a("h2",{attrs:{id:"为什么需要多线程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#为什么需要多线程"}},[s._v("#")]),s._v(" 为什么需要多线程")]),s._v(" "),a("p",[s._v("众所周知，CPU、内存、I/O 设备的速度是有极大差异的，为了合理利用 CPU 的高性能，平衡这三者的速度差异，计算机体系结构、操作系统、编译程序都做出了贡献，主要体现为:")]),s._v(" "),a("ul",[a("li",[s._v("CPU 增加了缓存，以均衡与内存的速度差异；// 导致 可见性问题")]),s._v(" "),a("li",[s._v("操作系统增加了进程、线程，以分时复用 CPU，进而均衡 CPU 与 I/O 设备的速度差异；// 导致 原子性问题")]),s._v(" "),a("li",[s._v("编译程序优化指令执行次序，使得缓存能够得到更加合理地利用。// 导致 有序性问题")])]),s._v(" "),a("hr"),s._v(" "),a("h2",{attrs:{id:"线程不安全示例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#线程不安全示例"}},[s._v("#")]),s._v(" 线程不安全示例")]),s._v(" "),a("p",[s._v("如果多个线程对同一个共享数据进行访问而不采取同步操作的话，那么操作的结果是不一致的。\n以下代码演示了 1000 个线程同时对 cnt 执行自增操作，操作结束之后它的值有可能小于 1000。")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadUnsafeExample")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" cnt "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        cnt"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" cnt"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br")])]),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" args"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("InterruptedException")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" threadSize "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1000")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadUnsafeExample")]),s._v(" example "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadUnsafeExample")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CountDownLatch")]),s._v(" countDownLatch "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("CountDownLatch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("threadSize"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ExecutorService")]),s._v(" executorService "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Executors")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("newCachedThreadPool")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" threadSize"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        executorService"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("execute")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            example"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            countDownLatch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("countDown")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    countDownLatch"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("await")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    executorService"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("shutdown")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("out"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("println")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("example"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("get")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("997")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 结果总是小于1000")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br")])]),a("h3",{attrs:{id:"并发出现问题的根源-并发三要素"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#并发出现问题的根源-并发三要素"}},[s._v("#")]),s._v(" 并发出现问题的根源: 并发三要素")]),s._v(" "),a("blockquote",[a("p",[s._v("上述代码输出为什么不是1000? 并发出现问题的根源是什么?")]),s._v(" "),a("ul",[a("li",[s._v("可见性: CPU缓存引起")]),s._v(" "),a("li",[s._v("原子性: 分时复用引起")]),s._v(" "),a("li",[s._v("有序性: 重排序引起")])])]),s._v(" "),a("h4",{attrs:{id:"可见性-cpu缓存引起"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#可见性-cpu缓存引起"}},[s._v("#")]),s._v(" 可见性: CPU缓存引起")]),s._v(" "),a("p",[s._v("可见性：一个线程对共享变量的修改，另外一个线程能够立刻看到。")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//线程1执行的代码")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\ni "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n \n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//线程2执行的代码")]),s._v("\nj "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])]),a("p",[s._v("假若执行线程1的是CPU1，执行线程2的是CPU2。由上面的分析可知，当线程1执行 i =10这句时，会先把i的初始值加载到CPU1的高速缓存中，然后赋值为10，那么在CPU1的高速缓存当中i的值变为10了，却没有立即写入到主存当中。")]),s._v(" "),a("p",[s._v("此时线程2执行 j = i，它会先去主存读取i的值并加载到CPU2的缓存当中，注意此时内存当中i的值还是0，那么就会使得j的值为0，而不是10.")]),s._v(" "),a("p",[s._v("这就是可见性问题，线程1对变量i修改了之后，线程2没有立即看到线程1修改的值。")]),s._v(" "),a("h4",{attrs:{id:"原子性-分时复用引起"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#原子性-分时复用引起"}},[s._v("#")]),s._v(" 原子性: 分时复用引起")]),s._v(" "),a("p",[s._v("原子性：即一个操作或者多个操作 要么全部执行并且执行的过程不会被任何因素打断，要么就都不执行。")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 线程1执行")]),s._v("\ni "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 线程2执行")]),s._v("\ni "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("p",[s._v("这里需要注意的是："),a("code",[s._v("i += 1")]),s._v("需要三条 CPU 指令")]),s._v(" "),a("ol",[a("li",[s._v("将变量 i 从内存读取到 CPU寄存器；")]),s._v(" "),a("li",[s._v("在CPU寄存器中执行 i + 1 操作；")]),s._v(" "),a("li",[s._v("将最后的结果i写入内存（缓存机制导致可能写入的是 CPU 缓存而不是内存）。")])]),s._v(" "),a("p",[s._v("由于CPU分时复用（线程切换）的存在，线程1执行了第一条指令后，就切换到线程2执行，假如线程2执行了这三条指令后，再切换会线程1执行后续两条指令，将造成最后写到内存中的i值是2而不是3。")]),s._v(" "),a("h4",{attrs:{id:"有序性-重排序引起"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#有序性-重排序引起"}},[s._v("#")]),s._v(" 有序性: 重排序引起")]),s._v(" "),a("p",[s._v("有序性：即程序执行的顺序按照代码的先后顺序执行。举个简单的例子，看下面这段代码：")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("              \n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("boolean")]),s._v(" flag "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\ni "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//语句1  ")]),s._v("\nflag "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[s._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("          "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//语句2")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("上面代码定义了一个int型变量，定义了一个boolean类型变量，然后分别对两个变量进行赋值操作。从代码顺序上看，语句1是在语句2前面的，那么JVM在真正执行这段代码的时候会保证语句1一定会在语句2前面执行吗? 不一定，为什么呢? 这里可能会发生指令重排序（Instruction Reorder）。")]),s._v(" "),a("p",[s._v("在执行程序时为了提高性能，编译器和处理器常常会对指令做重排序。重排序分三种类型：")]),s._v(" "),a("ul",[a("li",[s._v("编译器优化的重排序。编译器在不改变单线程程序语义的前提下，可以重新安排语句的执行顺序。")]),s._v(" "),a("li",[s._v("指令级并行的重排序。现代处理器采用了指令级并行技术（Instruction-Level Parallelism， ILP）来将多条指令重叠执行。如果不存在数据依赖性，处理器可以改变语句对应机器指令的执行顺序。")]),s._v(" "),a("li",[s._v("内存系统的重排序。由于处理器使用缓存和读 / 写缓冲区，这使得加载和存储操作看上去可能是在乱序执行。")])]),s._v(" "),a("p",[s._v("从 java 源代码到最终实际执行的指令序列，会分别经历下面三种重排序：")]),s._v(" "),a("p",[a("img",{attrs:{src:t(300),alt:"img"}})]),s._v(" "),a("p",[s._v("上述的 1 属于编译器重排序，2 和 3 属于处理器重排序。这些重排序都可能会导致多线程程序出现内存可见性问题。对于编译器，JMM 的编译器重排序规则会禁止特定类型的编译器重排序（不是所有的编译器重排序都要禁止）。对于处理器重排序，JMM 的处理器重排序规则会要求 java 编译器在生成指令序列时，插入特定类型的内存屏障（memory barriers，intel 称之为 memory fence）指令，通过内存屏障指令来禁止特定类型的处理器重排序（不是所有的处理器重排序都要禁止）。")]),s._v(" "),a("hr"),s._v(" "),a("h2",{attrs:{id:"java是怎么解决并发问题的-jmm-java内存模型"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#java是怎么解决并发问题的-jmm-java内存模型"}},[s._v("#")]),s._v(" JAVA是怎么解决并发问题的: JMM(Java内存模型)")]),s._v(" "),a("h3",{attrs:{id:"理解的第一个维度-核心知识点"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#理解的第一个维度-核心知识点"}},[s._v("#")]),s._v(" "),a("strong",[s._v("理解的第一个维度：核心知识点")])]),s._v(" "),a("p",[s._v("JMM本质上可以理解为，Java 内存模型规范了 JVM 如何提供按需禁用缓存和编译优化的方法。具体来说，这些方法包括：")]),s._v(" "),a("ul",[a("li",[s._v("volatile、synchronized 和 final 三个关键字")]),s._v(" "),a("li",[s._v("Happens-Before 规则")])]),s._v(" "),a("h3",{attrs:{id:"理解的第二个维度-可见性-有序性-原子性"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#理解的第二个维度-可见性-有序性-原子性"}},[s._v("#")]),s._v(" "),a("strong",[s._v("理解的第二个维度：可见性，有序性，原子性")])]),s._v(" "),a("p",[a("em",[a("strong",[s._v("原子性")])])]),s._v(" "),a("p",[s._v("在Java中，对基本数据类型的变量的读取和赋值操作是原子性操作，即这些操作是不可被中断的，要么执行，要么不执行。 请分析以下哪些操作是原子性操作：")]),s._v(" "),a("div",{staticClass:"language-ja line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("x = 10;        //语句1: 直接将数值10赋值给x，也就是说线程执行这个语句的会直接将数值10写入到工作内存中\ny = x;         //语句2: 包含2个操作，它先要去读取x的值，再将x的值写入工作内存，虽然读取x的值以及 将x的值写入工作内存 这2个操作都是原子性操作，但是合起来就不是原子性操作了。\nx++;           //语句3： x++包括3个操作：读取x的值，进行加1操作，写入新的值。\nx = x + 1;     //语句4： 同语句3\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br")])]),a("p",[s._v("上面4个语句只有语句1的操作具备原子性。")]),s._v(" "),a("p",[s._v("也就是说，只有简单的读取、赋值（而且必须是将数字赋值给某个变量，变量之间的相互赋值不是原子操作）才是原子操作。")]),s._v(" "),a("blockquote",[a("p",[s._v("从上面可以看出，Java内存模型只保证了基本读取和赋值是原子性操作，如果要实现更大范围操作的原子性，可以通过synchronized和Lock来实现。由于synchronized和Lock能够保证任一时刻只有一个线程执行该代码块，那么自然就不存在原子性问题了，从而保证了原子性。")])]),s._v(" "),a("p",[a("em",[a("strong",[s._v("可见性")])])]),s._v(" "),a("p",[s._v("Java提供了volatile关键字来保证可见性。")]),s._v(" "),a("p",[s._v("当一个共享变量被volatile修饰时，它会保证修改的值会立即被更新到主存，当有其他线程需要读取时，它会去内存中读取新值。")]),s._v(" "),a("p",[s._v("而普通的共享变量不能保证可见性，因为普通共享变量被修改之后，什么时候被写入主存是不确定的，当其他线程去读取时，此时内存中可能还是原来的旧值，因此无法保证可见性。")]),s._v(" "),a("blockquote",[a("p",[s._v("另外，通过synchronized和Lock也能够保证可见性，synchronized和Lock能保证同一时刻只有一个线程获取锁然后执行同步代码，并且在释放锁之前会将对变量的修改刷新到主存当中。因此可以保证可见性。")])]),s._v(" "),a("p",[a("em",[a("strong",[s._v("有序性")])])]),s._v(" "),a("p",[s._v("在Java里面，可以通过volatile关键字来保证一定的“有序性”（具体原理在下一节讲述）。另外可以通过synchronized和Lock来保证有序性，很显然，synchronized和Lock保证每个时刻是有一个线程执行同步代码，相当于是让线程顺序执行同步代码，自然就保证了有序性。当然JMM是通过Happens-Before 规则来保证有序性的。")]),s._v(" "),a("h3",{attrs:{id:"关键字-volatile、synchronized"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#关键字-volatile、synchronized"}},[s._v("#")]),s._v(" 关键字: volatile、synchronized")]),s._v(" "),a("ul",[a("li",[a("a",{attrs:{href:""}},[s._v("关键字: volatile详解")])]),s._v(" "),a("li",[s._v("关键字: synchronized详解")])])])}),[],!1,null,null,null);a.default=e.exports}}]);